## 关系网络说明（现状快照）

本文档记录小程序当前使用的亲属关系网络（口语化称谓）与推导规则，便于基于“关系网络”持续完善计算逻辑。公式路径长度以 5 为目标上限进行覆盖。

### 术语与代号

- 自我：我（性别由用户选择）
- 代号（tokens）：
  - f: 爸爸，m: 妈妈
  - h: 老公，w: 老婆
  - ob: 哥哥，yb: 弟弟，os: 姐姐，ys: 妹妹
  - s: 儿子，d: 女儿

### 规范化与计算原则

- 规范化（归约）

  - 配偶互反抵消：h-w 或 w-h 相邻出现视为同一人（配偶的配偶=本人），从序列中删除。
  - 辅助归约：兄/弟/姐/妹 + 配偶 + 子女 → 兄/弟/姐/妹 + 子女（称呼归属血亲）；父/母 + 兄/弟/姐/妹 + 配偶 + 子女 同理。

- 直系上行（仅含 f/m）

  - 1 层：f → 爸爸，m → 妈妈
  - 2 层：ff → 爷爷，fm → 奶奶；mf → 外公，mm → 外婆
  - ≥3 层：父系用“太 ×n + 爷/奶”，母系用“外 + 太 ×n + 公/婆”（已覆盖到 5 层的口语化）

- 直系下行（仅含 s/d）

  - 1 层：s → 儿子，d → 女儿
  - 2 层：ds → 外孙子，dd → 外孙女；ss → 孙子，sd → 孙女
  - ≥3 层：曾/玄/来 + 孙 + 子/女（女儿线前置“外”），已覆盖到 5 层

- 祖辈链 + 配偶（… + w/h）

  - 示例：f-f-w（爸爸-爸爸-老婆）→ 奶奶；整体规则：切换最末祖辈性别后再按祖辈命名。

- 配偶 + 祖辈链（w/h + f/m…）

  - w + f → 岳父，w + m → 岳母；h + f → 公公，h + m → 婆婆
  - 进一步上推：岳爷爷/岳奶奶，太岳父/太岳母，太太岳父/太太岳母，…；公婆系：祖公公/祖婆婆，太公公/太婆婆，太太公公/太太婆婆，…

- 配偶 + 后代链（w/h + s/d…）

  - 等价于“我的后代”（后代与我配偶共有），直接使用直系下行规则。

- 后代链 + 配偶（… + w/h）

  - 例：s + w → 儿媳；d + h → 女婿
  - 多代：将末尾“子/女”替换为“媳/婿”，如“孙子”→“孙媳”，“曾孙女”→“曾孙女婿”，覆盖至来孙层。

- 兄弟姐妹与其配偶、子女

  - 兄弟姐妹的配偶：
    - ob/y b + w → 嫂子/弟媳；os/ys + h → 姐夫/妹夫
  - 兄弟姐妹的子女：
    - 兄（ob/yb）的子女 → 侄子/侄女
    - 姐/妹（os/ys）的子女 → 外甥/外甥女
  - 兄弟姐妹 + 配偶 + 子女：与“兄弟姐妹的子女”一致（配偶不改变称呼归属）

- 父/母 + 兄弟姐妹 + 子女（堂/表）

  - 父系 + 父之兄弟（ob/yb）之子女 → 堂兄弟/堂姐妹（不细分长幼）
  - 其他（父之姐妹、母系舅姨）之子女 → 表兄弟/表姐妹（不细分长幼）

- 配偶的兄弟姐妹（按我本人的性别）

  - 男（w 开头）：大舅子/小舅子、大姨子/小姨子
  - 女（h 开头）：大伯子/小叔子、大姑子/小姑子

- 反向称呼（“他们称呼我”）
  - 一次关系：父/母 → 儿子/女儿；儿/女 → 爸爸/妈妈；w → 老公；h → 老婆；兄/姊 → 我是弟弟/妹妹；弟/妹 → 我是哥哥/姐姐
  - 祖辈链（2~4 层）：祖父母 → 孙子/孙女；曾祖父母 → 曾孙子/曾孙女；高祖父母 → 玄孙子/玄孙女
  - 配偶父母：w + f/m → 女婿；h + f/m → 儿媳

### 一次关系映射（resultMap 基础节点）

- 自我 → 爸爸/妈妈/老公/老婆/哥哥/弟弟/姐姐/妹妹/儿子/女儿

### 组合规则摘要（部分举例，均已实现）

- 祖辈：

  - f → 爸爸；m → 妈妈；ff → 爷爷；fm → 奶奶；mf → 外公；mm → 外婆
  - fff → 太爷爷；ffm → 太奶奶；mff → 外太公；mmf → 外太公（同类类推至 5 层）

- 配偶方祖辈：

  - w f → 岳父，w m → 岳母；w ff → 岳爷爷/岳奶奶；w fff → 太岳父/太岳母 …
  - h f → 公公，h m → 婆婆；h ff → 祖公公/祖婆婆；h fff → 太公公/太婆婆 …

- 兄弟姐妹与子女：

  - ob/os/yb/ys + w/h → 嫂子/弟媳/姐夫/妹夫
  - ob/yb + s/d → 侄子/侄女；os/ys + s/d → 外甥/外甥女
  - f/m + ob/yb + s/d → 堂兄弟/堂姐妹；其余 → 表兄弟/表姐妹

- 后代与配偶：

  - s/w → 儿媳；d/h → 女婿
  - ss/sd/ds/dd 等 → 孙/外孙；再加 s/d → 曾/玄/来 孙；末尾 + w/h → 孙媳/孙女婿/曾孙媳/…

- 祖辈链 + 配偶：
  - ffw → 奶奶；fmh → 爷爷（按末节点切换性别后按祖辈命名）

### UI/交互约束（与关系网络相关）

- 配偶键禁用：若当前公式末端人物为男性，则“老公”禁用；为女性，则“老婆”禁用。
- 夜间模式：文字、禁用态有较高对比度（不影响关系推导）。

### 覆盖范围与测试建议

- 目标：公式长度 ≤ 5 的常见路径均有结果。
- 推荐自测样例（口语 → 预期）：
  - 爸爸-爸爸-老婆 → 奶奶
  - 老婆-爸爸-爸爸 → 岳爷爷
  - 儿子-儿子-老婆 → 孙媳
  - 妈妈-哥哥-儿子 → 堂兄弟（或表兄弟，视实现：父系+父之兄弟为堂，其余为表）
  - 姐姐-丈夫-妹妹 → 小姑子（女性配偶方姐妹）
  - 哥哥-妻子-儿子 → 侄子（配偶不改变侄外甥归属）
  - 爸爸-妹妹-丈夫 → 姨夫；妈妈-弟弟-妻子 → 舅妈
  - 老婆-女儿-儿子 → 外孙子；老公-儿子-女儿 → 孙女

### 当前已知简化与待完善

- 堂/表与长幼（堂兄/堂弟/表哥/表弟…）未细分到位；
- 地域差异称谓（伯/叔/姑/舅/姨 的口语细分）仍有简化；
- 反向称呼仅覆盖常见路径；
- 极端组合与同代侧系的更细颗粒规则需逐步补齐。

### 扩展指引（按“网络优先”改进）

1. 以 md 补齐“缺失节点/边”（新增代号或别名），标注口语称谓与适用条件（性别、父母系）。
2. 在代码中仅做规则归约与查表，不在逻辑层里硬编码具体称谓文本；称谓文本以“网络”为准。
3. 每次完善后用固定用例集做回归（建议将上述“推荐自测样例”固化为测试列表）。

### 代号总表（便于对照）

- f 爸爸
- m 妈妈
- h 老公
- w 老婆
- ob 哥哥
- yb 弟弟
- os 姐姐
- ys 妹妹
- s 儿子
- d 女儿

### 关系图

#### 一级关系（直接关系）

f = 爸爸
m = 妈妈
h = 老公
w = 老婆
ob = 哥哥
yb = 弟弟
os = 姐姐
ys = 妹妹
s = 儿子
d = 女儿
#### 二级关系
f-f = 爷爷

f-m = 奶奶

f-ob = 伯父

f-yb = 叔叔

f-os = 姑妈

f-ys = 姑妈

f-h = 丈人

f-w = 丈母

f-s = 儿子

f-d = 女儿
m-f = 外公

m-m = 外婆

m-ob = 舅舅

m-yb = 舅舅

m-os = 舅妈

m-ys = 舅妈

m-h = 岳父

m-w = 岳母

m-s = 儿子

m-d = 女儿
ob-f = 父亲

ob-m = 母亲

ob-ob = 大侄子

ob-yb = 小侄子

ob-os = 姐姐

ob-ys = 妹妹

ob-h = 姐夫

ob-w = 侄女婿

ob-s = 侄子

ob-d = 侄女
yb-f = 父亲

yb-m = 母亲

yb-ob = 哥哥

yb-yb = 小侄子

yb-os = 姐姐

yb-ys = 妹妹

yb-h = 弟妹

yb-w = 侄女婿

yb-s = 侄子

yb-d = 侄女

os-f = 爸爸

os-m = 妈妈

os-ob = 哥哥

os-yb = 弟弟

os-os = 姐姐

os-ys = 妹妹

os-h = 姐夫

os-w = 外甥女婿

os-s = 外甥

os-d = 外甥女

ys-f = 爸爸

ys-m = 妈妈

ys-ob = 哥哥

ys-yb = 弟弟

ys-os = 姐姐

ys-ys = 妹妹

ys-h = 妹夫

ys-w = 外甥女婿

ys-s = 外甥

ys-d = 外甥女

h-f = 岳父

h-m = 岳母

h-ob = 姐夫

h-yb = 弟妹

h-os = 妻子的姐姐

h-ys = 妻子的妹妹

h-h = 老公

h-w = 老婆

h-s = 儿子

h-d = 女儿

w-f = 丈父

w-m = 丈母

w-ob = 姐夫

w-yb = 弟妹

w-os = 妻子的姐姐

w-ys = 妻子的妹妹

w-h = 老公

w-w = 老婆

w-s = 儿子

w-d = 女儿

s-f = 爸爸

s-m = 妈妈

s-ob = 叔叔

s-yb = 舅舅

s-os = 姑妈

s-ys = 姑妈

s-h = 岳父

s-w = 岳母

s-s = 自己

s-d = 女儿

d-f = 爸爸

d-m = 妈妈

d-ob = 舅舅

d-yb = 舅舅

d-os = 舅妈

d-ys = 舅妈

d-h = 姐夫

d-w = 外甥女婿

d-s = 外甥

d-d = 自己
#### 三级关系
f-f-f = 曾祖父

f-f-m = 曾祖母

f-m-f = 外曾祖父

f-m-m = 外曾祖母

f-ob-f = 伯祖父

f-ob-m = 伯祖母

f-yb-f = 叔祖父

f-yb-m = 叔祖母

f-os-f = 姑曾祖父

f-os-m = 姑曾祖母

f-ys-f = 姑祖父

f-ys-m = 姑祖母

m-f-f = 外曾祖父

m-f-m = 外曾祖母

m-m-f = 外外公

m-m-m = 外外婆
#### 四级关系
f-f-f-f = 太高祖父

f-f-f-m = 太高祖母

f-f-m-f = 太高祖父

f-f-m-m = 太高祖母

f-m-f-f = 外高祖父

f-m-f-m = 外高祖母

f-m-m-f = 外高祖父

f-m-m-m = 外高祖母

f-ob-f-f = 伯高祖父

f-ob-f-m = 伯高祖母

f-yb-f-f = 叔高祖父

f-yb-f-m = 叔高祖母

f-os-f-f = 姑高祖父

f-os-f-m = 姑高祖母

f-ys-f-f = 姑高祖父

f-ys-f-m = 姑高祖母

m-f-f-f = 外高祖父

m-f-f-m = 外高祖母

m-f-m-f = 外高祖父

m-f-m-m = 外高祖母

m-m-f-f = 外外高祖父

m-m-f-m = 外外高祖母
#### 五级关系
f-f-f-f-f = 更高一代祖父

f-f-f-f-m = 更高一代祖母

f-f-f-m-f = 更高一代祖父

f-f-f-m-m = 更高一代祖母

f-f-m-f-f = 曾高祖父

f-f-m-f-m = 曾高祖母

f-f-m-m-f = 曾高祖父

f-f-m-m-m = 曾高祖母